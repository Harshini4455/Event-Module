<%- include('../partials/header') %>

<div class="container mt-4">
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h4>Manage Media: <%= event.title %></h4>
      <a href="/admin/events" class="btn btn-sm btn-outline-secondary">
        Back to Events
      </a>
    </div>
    
    <div class="card-body">
      <% if (messages.success) { %>
        <div class="alert alert-success"><%= messages.success %></div>
      <% } %>
      <% if (messages.error) { %>
        <div class="alert alert-danger"><%= messages.error %></div>
      <% } %>
      
      <form action="/admin/events/<%= event._id %>/media" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label>Upload Media (Max 30 files)</label>
          <div class="custom-file">
            <input type="file" class="custom-file-input" id="media" name="media" multiple accept="image/*,video/*">
            <label class="custom-file-label" for="media">Choose files...</label>
          </div>
          <small class="form-text text-muted">
            Supported formats: JPG, PNG, GIF, MP4, MOV, AVI (Max 50MB each)
          </small>
        </div>
        <button type="submit" class="btn btn-primary">Upload</button>
      </form>
      
      <hr>
      
      <div class="media-gallery mt-4">
        <div class="row">
          <% event.media.forEach((media, index) => { %>
            <div class="col-md-4 mb-4">
              <div class="card">
                <% if (media.type === 'image') { %>
                  <img src="<%= media.url %>" class="card-img-top" alt="Event Image">
                <% } else { %>
                  <div class="embed-responsive embed-responsive-16by9">
                    <video controls class="embed-responsive-item">
                      <source src="<%= media.url %>" type="video/mp4">
                    </video>
                  </div>
                <% } %>
                <div class="card-body">
                  <textarea class="form-control mb-2 caption-input" 
                            data-media-id="<%= media._id %>"
                            placeholder="Add caption"><%= media.caption %></textarea>
                  <button class="btn btn-sm btn-danger delete-media" 
                          data-media-id="<%= media._id %>">
                    Delete
                  </button>
                </div>
              </div>
            </div>
          <% }); %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Handle media deletion
document.querySelectorAll('.delete-media').forEach(btn => {
  btn.addEventListener('click', async function() {
    if (!confirm('Are you sure you want to delete this media?')) return;
    
    const mediaId = this.dataset.mediaId;
    try {
      const response = await fetch(`/admin/events/<%= event._id %>/media/${mediaId}`, {
        method: 'DELETE'
      });
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to delete media');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Failed to delete media');
    }
  });
});

// Handle caption updates
document.querySelectorAll('.caption-input').forEach(input => {
  input.addEventListener('change', async function() {
    const mediaId = this.dataset.mediaId;
    const caption = this.value;
    
    try {
      const response = await fetch(`/admin/events/<%= event._id %>/media/${mediaId}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ caption })
      });
      
      if (!response.ok) {
        alert('Failed to update caption');
      }
    } catch (err) {
      console.error('Error:', err);
      alert('Failed to update caption');
    }
  });
});

// Update file input label
document.querySelector('.custom-file-input').addEventListener('change', function(e) {
  const files = e.target.files;
  const label = this.nextElementSibling;
  if (files.length > 1) {
    label.textContent = `${files.length} files selected`;
  } else if (files.length === 1) {
    label.textContent = files[0].name;
  } else {
    label.textContent = 'Choose files...';
  }
});
</script>

<%- include('../partials/footer') %>